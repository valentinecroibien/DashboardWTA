---
title: "Women's Tennis Association"
output: 
  flexdashboard::flex_dashboard:
    orientation : row
    vertical_layout: fill
    theme : flatly
    source_code: embed
  runtime : shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(here)
library("tidyverse")
library("magrittr")
library("stringr")
library('purrr')
library("dplyr")
library("DataExplorer")
library("lubridate")

list_files <- list.files(here("tennis_wta"))

list_matches <- grep(pattern = "^wta_matches_2[[:digit:]]{3}.csv$", x = list_files, value = TRUE)

list_qualifs <- grep(pattern = "^wta_matches_qual_itf_2[[:digit:]]{3}.csv$", x = list_files, value = TRUE)

list_players <- grep(pattern = "^wta_players.csv$", x = list_files, value = TRUE)

list_rankings <- grep(pattern = "^wta_rankings_[[:digit:]]{2}s.csv$", x = list_files, value = TRUE)

list_rankings <- list_rankings[1:3]
list_rankings[4] <- grep(pattern = "^wta_rankings_current.csv$", x = list_files, value = TRUE)


#### Liste des tibbles des matches de 2000 à 2021 ####
# On crée le vecteur de chaines de caractères des nom des tibbles qu'on va créer lors de l'importation
lst_names <- paste('wta_', str_extract(string = list_matches, pattern = "[[:digit:]]{4}"), sep = "")

# On effectue une boucle avec map (ou lapply) pour importer les donnees et stocker les tibbles dans une liste
lst_matchs <- map(.x = list_matches, 
                  .f = function (x) read_csv(paste("tennis_wta/", 
                                                   x, sep = ""), col_types = 'cccdcdddccccdcddccccdcdcdcddddddddddddddddddddddd'))
names(lst_matchs) <- lst_names

# Recolloage des bases à l'aide de la fonction reduce
# Résultats des matches de 2000 à 2021
wta_matches <- reduce(.x = lst_matchs, .f = bind_rows)


#### Liste des tibbles des matches de qualification de 2000 à 2021 ####
# On crée le vecteur de chaines de caractères des nom des tibbles qu'on va créer lors de l'importation
lst_names <- paste('wta_qualif', str_extract(string = list_qualifs, pattern = "[[:digit:]]{4}"), sep = "")

# On effectue une boucle avec map (ou lapply) pour importer les donnees et stocker les tibbles dans une liste
lst_qualifs <- map(.x = list_qualifs, 
                   .f = function (x) read_csv(paste("tennis_wta/", 
                                                    x, sep = ""), col_types = 'cccdcdddccccdcddccccdcdcdcddddddddddddddddddddddd' ))
names(lst_qualifs) <- lst_names

# Recolloage des bases à l'aide de la fonction reduce
# Résultats des matches qualifs de 2000 à 2021
wta_qualifs <- reduce(.x = lst_qualifs, .f = bind_rows)



#### Liste des classements de 2000 à 2021 ####
# On crée le vecteur de chaines de caractères des nom des tibbles qu'on va créer lors de l'importation

# On effectue une boucle avec map (ou lapply) pour importer les donnees et stocker les tibbles dans une liste
lst_rankings <- map(.x = list_rankings, 
                    .f = function (x) read_csv(paste("tennis_wta/", 
                                                     x, sep = ""), col_types = "ddddd"))
names(lst_rankings) <- list_rankings

# Recolloage des bases à l'aide de la fonction reduce
# Résultats des matches qualifs de 2000 à 2021
wta_rankings <- reduce(.x = lst_rankings, .f = bind_rows)

#### Liste des joueurs ####
wta_players <- read_csv("tennis_wta/wta_players.csv")
wta_players <- wta_players[-c(1:2),]


#### Liste des matchs joués par Justine Hénin (gagnante ou perdante) ####
## Qualifications 
wta_qualifs %>% 
  filter(winner_name == "Justine Henin" | loser_name == "Justine Henin") %>%
  select(-c(winner_seed, winner_entry, loser_seed, loser_entry, minutes, w_SvGms, l_SvGms)) -> qualifs_JH

## Matchs
wta_matches %>% 
  filter(winner_name == "Justine Henin" | loser_name == "Justine Henin") %>%
  select(-c(winner_seed, winner_entry, loser_seed, loser_entry, minutes, w_SvGms, l_SvGms)) -> matches_JH
```

Vision générale de la carrière
===================================== 

Ligne 1 {data-width=500}
-----------------------------------------------------------------------

### Profil de la joueuse
```{r}
dob_JH <- wta_players$dob[which(wta_players$name_last == "Henin")]
annee <- str_sub(dob_JH, 1, 4)
mois <- str_sub(dob_JH, 5, 6)
jour <- str_sub(dob_JH, 7, 8)

dob_JH <- paste(jour, mois, annee, sep = "/")
dob_JH <- as.Date(dob_JH,format="%d/%m/%Y")


height_JH <- wta_players$height[which(wta_players$name_last == "Henin")]
hand_JH <- wta_players$hand[which(wta_players$name_last == "Henin")]
if (hand_JH =='R') {
  hand_JH = 'Droite'
}else{
   hand_JH = 'Gauche'
}
```


<div class = "row">
<div class = "col-md-6">
<center>
```{r picture, echo = F, fig.cap = "Title", out.width = '100%'}
knitr::include_graphics("Justine_Henin_RG2010.jpeg")
```
</center>
</div>

<div class = "col-md-6">
<center> 
<h2>Justine Henin</h2>
</center>
<p> <a>Date de naissance :</a> `r dob_JH`, (`r trunc(time_length(interval(dob_JH, Sys.time()), "years"))` ans)</p>
<p> <a>Taille :</a> `r height_JH` cm</p>
<p> <a>Main :</a> `r hand_JH`</p>
</div>
</div>

### Évolution dans le classement 

```{r, fig.width = 9, fig.height = 5}
id_JH <- wta_players$player_id[which(wta_players$name_last == "Henin")]

annee <- str_sub(wta_rankings$ranking_date, 1, 4)
mois <- str_sub(wta_rankings$ranking_date, 5, 6)
jour <- str_sub(wta_rankings$ranking_date, 7, 8)

wta_rankings$ranking_date <- paste(jour, mois, annee, sep = "/")
wta_rankings$ranking_date <- as.Date(wta_rankings$ranking_date,format="%d/%m/%Y")

wta_rankings %>%
  filter(player == id_JH) %>%
  select(c(ranking_date, rank, points)) -> rankings_JH

library("scales")
ggplot(data = rankings_JH, aes(x=ranking_date, y = rank)) +
  geom_line(size = 0.5, color = "#CC3300") +
  scale_y_reverse() + 
  ylab("Rang") +
  xlab("Date") +
  theme(axis.text.x = element_text(angle=45))
```

Nombre clés {data-width = 150}
-----------------------------------------------------------------------

### Nombre de médailles
```{r}
medals = "1 médaille d'or"
valueBox(value = medals,icon = "fas fa-medal",caption = "Nombre de médailles", color = "lightgreen")
```

### Nombre de titres
```{r}
title = 43
valueBox(value = title,icon = "fas fa-trophy",caption = "Nombre de titres", color = "lightblue")
```

### Gains en tournois
```{r}
win = '20 863 335 $'
valueBox(value = win, icon = "fas fa-dollar-sign",caption = "Gains en tournois", color = "lightpink")
```

Victoires {data-width = 500}
-----------------------------------------------------------------------

### Pourcentage de victoire par type de surface
```{r}
matches_JH$surface <- factor(matches_JH$surface, labels = c("Moquette", "Terre Battue", "Gazon", "Dur"))
Surface.Variables <- levels(matches_JH$surface)
selectInput("surface_variable", label = "Sélectionner le type de surface", choices = Surface.Variables)
```


<div class = "row">
<div class = "col-md-6">
<center>
```{r}
victory_hard = 55
gauge(victory_hard, min = 0, max = 100, symbol = '%', label = "Dur" ,gaugeSectors(
  success = c(70, 100), warning = c(40, 70), danger = c(0, 40)
))
```
</center>
</div>

<div class = "col-md-6">
<center>    
```{r}
victory_carpet = 30
gauge(victory_carpet, min = 0, max = 100,  symbol = '%', label = "Moquette" , gaugeSectors(
  success = c(70, 100), warning = c(40, 70), danger = c(0, 40)
))
```   
</center>
</div>

<div class = "col-md-6">
<center>    
```{r}
victory_clay = 70
gauge(victory_clay, min = 0, max = 100, symbol = '%', label = "Terre Battue" ,  gaugeSectors(
  success = c(70, 100), warning = c(40, 70), danger = c(0, 40)
))
``` 
</center>
</div>

<div class = "col-md-6">
<center>    
```{r}
victory_grass = 50
gauge(victory_grass, min = 0, max = 100,  symbol = '%', label = "Gazon" , gaugeSectors(
  success = c(70, 100), warning = c(40, 70), danger = c(0, 40)
))
```
</center>
</div>
</div>

### Répartition des victoires et défaites face à ses principales adversaires
```{r}
matches_JH %>%
    select(tourney_date, tourney_name, tourney_level, surface, round, winner_name, loser_name, score) %>%
    mutate(opponent = case_when(winner_name == "Justine Henin" ~ loser_name,
                                winner_name != "Justine Henin" ~ winner_name),
           result =case_when(winner_name == "Justine Henin" ~ "Won",
                             winner_name != "Justine Henin" ~ 'Lost')) %>%
    select(-winner_name, -loser_name) -> summary_carriere

summary_carriere %>%
  select(-opponent, -score) %>%
  filter(tourney_level %in% c("A", "M", "G")) %>%
  mutate(tourney_result = case_when(round == 'F' & result == 'Won' ~ 'W',
                                    result == 'Lost' ~ round)) %>%
  drop_na(tourney_result) %>%
  arrange(tourney_date) -> matches_JH
```

```{r,  fig.width = 11, fig.height = 5}
summary_carriere %>%
  group_by(opponent, result) %>%
  summarize(`Nombre de matchs` = n()) %>%
  filter(`Nombre de matchs` >= 5) %>%
  ungroup() %>% #Penser à dégrouper pour pouvoir calculer Total par la suite
  #On arrange un peu la présentation du tableau
  pivot_wider(names_from = result, values_from  = `Nombre de matchs`) %>%
  mutate(Total = apply(select(., Won, Lost), 1, sum, na.rm = TRUE)) %>%
  arrange(desc(Total))-> op

op %>%
  pivot_longer(cols = c(Won, Lost), names_to = "result", values_to = "eff") %>%
  ggplot(mapping = aes(x = reorder(opponent, Total), y = eff, fill = result)) +
  geom_col() +
  scale_fill_discrete(type = c('Lost' = "tomato3", "Won" = "lightgreen")) +
  coord_flip() +
  theme_bw() +
  labs(y = "Nombre de confrontations", x = 'Adversaires') +
  geom_text(mapping = aes(y = -0.1, label = Total), size = 2) +
  labs(fill = "Résultat")
```


Vision d'une saison de la joueuse
===================================== 


Vision d'un tournoi
===================================== 

